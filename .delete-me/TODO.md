# TODO 
[x] 1. Rebase PR https://github.com/rhobs/konflux-coo/pull/684 so that new Pipelines are includes in the .tekton files 
[x] 2. Update EnterpriseContractPolicy with 0.3/6.0 and 0.4/6.1 uiplugins https://gitlab.cee.redhat.com/releng/konflux-release-data/-/merge_requests/4792
        Note: Because of PF4 support we need to have both  0.3/6.0 (PF4) and 0.4/6.1 (PF5) versions of the plugins https://github.com/rhobs/observability-operator/pull/689/files 
        ONLY ADD distributed tracing and logging (see the lifecycle chart )
        - Only logging and tracing is needed for two version 0.3/6.0 and 0.4/6.1
[ ] 3. Add Perses backend as a new component 
[ ] 4. Add Hermetic Build 
        1. all new uiplugins 0.4/6.1
[ ] 5. Update Render_templates -- this allow the staging relases to build the /konflux-coo image (Gabriel to send me instructions)
        1. Add Perses_operator 
            Change the deployment
        2. Add Perses_backend 
            Change the image that is being checked 
            Script that changes the CSV (Cluster service version) https://github.com/rhobs/konflux-coo/blob/release-1.1/bundle-patches/render_templates
            Original CSV: https://github.com/rhobs/observability-operator/blob/main/bundle/manifests/observability-operator.clusterserviceversion.yaml
            Changes needed in Konflux coo CSV (Cluster service version) to complete the components on boarding: 
                Adjust the render_patches script to override the Perses Operator image with the one generated from the konflux pipeline in the perses-operator deployment
                Adjust the render_patches script to include the Perses Image, generated from the konflux pipeline, as part of the perses-operator deployment args
[ ] 6. Check Konflux UI Application > COO 1.1 > Components 
        1. Perses Operator should be included here 
        2. Perses should be included here 
[ ] 7. COO Testing, check testing doc 
        1. Konflux should build an image and store it in https://quay.io/organization/redhat-user-workloads/cluster-observabilit-tenant, we need to pull this image, deploy it on a cluster and check that there's no issues running the uiplugins 

### Pending PR/MR
[ ] Add autogenerated files for perses-operator https://gitlab.cee.redhat.com/releng/konflux-release-data/-/merge_requests/4812
[ ] Update EnterpriseContractPolicy https://gitlab.cee.redhat.com/releng/konflux-release-data/-/merge_requests/4792


# Questions 
1. Do I need to run `make generate` to update the Catalogue for this PR? I tried to do it and I threw an error because I don't have credentials  to access https://quay.io/organization/redhat-user-workloads/cluster-observabilit-tenant

### Add 
1. add perses-operator to .gitmodule
2. git submodule add https://github.com/perses/perses-operator
3. add Dockerfile.perses-operator 


### Update 
git submodule status

git submodule update --init ui-logging
OR 
git submodule update --remote 

git submodule status


OUTPUT from `git submodule status` 
 4ce04fb010bd626fca35928dcfe82f6f2da52ced alertmanager (v0.28.0)
 5a07c3175ee552217ab11b341823c48551529676 korrel8r (v0.7.5-1-g5a07c31)
 b486a6b0b609185d029455ee532e4b99b0a83370 obo-prometheus-operator (pkg/apis/monitoring/v0.78.1-rhobs1-1-gb486a6b0b)
 29b4c0b138c8b7e8c7146d4db01d44522c2c3e55 observability-operator (v1.0.0-2-g29b4c0b)
 33a3677a7fa3d96987abdb5d880e7dca80a117ed perses-operator (v0.1.1-4-g33a3677)
 fb933aea1d6e843e67755adad7239aebf20cf856 prometheus (v0.55.1-3-gfb933aea1)
 314589cf9b4e86507634ab3406deb08402fa7af9 thanos (v0.5.0-rc.0-3420-g314589cf9)
+dd5226a5c2671f66dc38a23d606db0d82a2284c4 ui-dashboards (v0.1.0-46-gdd5226a)
+8633ddaad3e76192def9e55db70b1ac3f7652021 ui-distributed-tracing (heads/main)
+bdabda3e49b8bc14ebbd3a5156410be05fb7becc ui-logging (remotes/origin/release-6.1)
+c1cd4ce52a14a4d5a160edd0c66d010aedce2b62 ui-monitoring (heads/main)
+740ca51a5c4ebb8903fe2b6d7210f60bbbf7e7e4 ui-troubleshooting-panel (heads/main)


# branch add-perses-backend 
1. rhobs/konflux-coo 
    1. Add component to .gitmodules 
    2. git add submodule <perses-backend-url>


## Fetch a remote branch upstream 
```
# add upstream to places git can pull from 
git add remote upstream https://github.com/perses/perses.git

# get all the branches from upstream 
git fetch upstream 

# copy upstream branch (redhat-release-coo-1.1) to local machine (jz-redhat-release-coo-1.1)
git checkout -b jz-redhat-release-coo-1.1 upstream/redhat-release-coo-1.1

# point head of branch to release v0.50.1 (commit 3dc3fb9e5a493923fd3dc2e3c9c8399a4cc0c41f)
git reset --hard 3dc3fb9e5a493923fd3dc2e3c9c8399a4cc0c41f

# force push to reset remote branch 
git push --force upstream HEAD:redhat-release-coo-1.1

```
# Add Perses 
1. add perses to .gitmodule
2. git submodule add https://github.com/perses/perses.git
3. git submodule update --remote  (to run .gitmodule which updates submodule to point at specified branch redhat-release-coo-1.1)
4. add Dockerfile.perses
5. docker build -f Dockerfile.perses -t my-app-perses .

### Build Dockerfile.perses
```
# FROM brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_8_golang_1.23 AS build-env
# USER root
$ docker run --name jz-perses --user root -it  brew.registry.redhat.io/rh-osbs/openshift-golang-builder:rhel_8_golang_1.23 /bin/bash

# Check whoami; should be root
$ whoami 

# RUN dnf install -y mailcap && dnf clean all && rm -rf /var/cache/dnf
$ dnf install -y mailcap && dnf clean all && rm -rf /var/cache/dnf

# WORKDIR /app
$ mkdir app && cd app 

$ exit 

# COPY perses/ .
$ docker cp /path/to/perses/ my-container:/path/in/container
$ docker cp /perse jz-perses:/app

# restart the stopped container 
$ docker start jz-perses

# go into the container 
$ docker exec -it jz-perses /bin/bash


$ docker exec -it docker.io/library/jz-perses-2:latest /bin/bash


# check the files are copied 
$ cd app && ls 

```


### Build, Run, Expose Port, Curl API 
```
docker build -t jz-perses-2 -f Dockerfile.perses .  
docker run --user root -it docker.io/library/jz-perses-2:latest /bin/bash
docker run --publish 8080:8080 jz-perses-2
curl http://localhost:8080
```

